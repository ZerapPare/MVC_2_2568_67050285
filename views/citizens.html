<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Citizens</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header class="nav">
    <div class="nav__inner">
      <a class="brand" href="index.html"><span class="brand__dot"></span> MVC</a>
      <nav class="nav__links">
        <a class="pill" data-nav href="citizens.html">ประชาชน</a>
        <a class="pill" data-nav href="shelters.html">ที่พักพิง</a>
        <a class="pill" data-nav href="report.html">รายงาน</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="header">
      <div>
        <h1 class="h1">ลงทะเบียนประชาชน</h1>
        <p class="sub">เพิ่มข้อมูลประชาชน + ดูรายการทั้งหมด + แยกประเภท</p>
      </div>
      <span id="toast" class="badge" style="display:none"></span>
    </div>

    <div class="grid cols-2">
      <section class="card">
        <h2>เพิ่มประชาชน</h2>

        <div class="row">
          <div>
            <label>รหัสประชาชน (citizenId)</label>
            <input id="citizenId" placeholder="เช่น C004" />
          </div>
          <div>
            <label>ชื่อ</label>
            <input id="name" placeholder="ชื่อ" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>อายุ</label>
            <input id="age" type="number" min="0" placeholder="เช่น 21" />
          </div>
          <div>
            <label>สถานะสุขภาพ</label>
            <select id="healthStatus">
              <option>Healthy</option>
              <option>Chronic</option>
              <option>Injured</option>
              <option>Disabled</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>วันที่ลงทะเบียน</label>
            <input id="registerDate" type="date" />
          </div>
          <div>
            <label>ประเภทประชาชน</label>
            <select id="citizenType">
              <option>ทั่วไป</option>
              <option>กลุ่มเสี่ยง</option>
              <option>VIP</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnAdd">บันทึก</button>
          <button class="btn" id="btnExport">Export citizens.csv</button>
        </div>
      </section>

      <section class="card">
        <h2>ตัวกรอง</h2>
        <div class="row">
          <div>
            <label>ค้นหา (id/ชื่อ)</label>
            <input id="q" placeholder="พิมพ์เพื่อค้นหา..." />
          </div>
          <div>
            <label>ประเภท</label>
            <select id="filterType">
              <option value="">ทั้งหมด</option>
              <option value="ทั่วไป">ทั่วไป</option>
              <option value="กลุ่มเสี่ยง">กลุ่มเสี่ยง</option>
              <option value="VIP">VIP</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <p class="small muted">หมายเหตุ: ระบบไม่อนุญาตให้เพิ่มประชาชนซ้ำรหัส</p>
      </section>
    </div>

    <section class="card" style="margin-top:14px">
      <h2>ประชาชนทั้งหมด</h2>
      <table class="table">
        <thead>
          <tr>
            <th>citizenId</th>
            <th>ชื่อ</th>
            <th>อายุ</th>
            <th>สุขภาพ</th>
            <th>วันที่ลงทะเบียน</th>
            <th>ประเภท</th>
            <th>ที่พัก (ถ้ามี)</th>
            <th>กรรมการ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
  </main>

  <script src="../src/app.js"></script>
  <script>
    EVAC.Controller.init();
    EVAC.setActiveNav();

    document.getElementById("registerDate").value = EVAC.todayISO();

    function render(){
      const q = document.getElementById("q").value.trim().toLowerCase();
      const ft = document.getElementById("filterType").value;

      const rows = EVAC.DB.citizens
        .filter(c => {
          if (ft && c.citizenType !== ft) return false;
          if (!q) return true;
          return (c.citizenId || "").toLowerCase().includes(q) ||
                 (c.name || "").toLowerCase().includes(q);
        })
        .map(c => {
          const shelterId = EVAC.getAssignedShelterId(c.citizenId);
          const shelter = shelterId ? EVAC.findShelter(shelterId) : null;
          return {
            ...c,
            shelterLabel: shelter ? `${shelter.shelterId} - ${shelter.name}` : ""
          };
        });

      const tb = document.getElementById("tbody");
      tb.innerHTML = rows.map(r => {
        const assigned = EVAC.getAssignedShelterId(r.citizenId);
        return `
        <tr>
          <td>${r.citizenId}</td>
          <td>${r.name}</td>
          <td>${r.age}</td>
          <td>${r.healthStatus}</td>
          <td>${r.registerDate}</td>
          <td>${r.citizenType}</td>
          <td>${r.shelterLabel || `<span class="badge warn">ยังไม่เข้าที่พัก</span>`}</td>
          <td>
            ${assigned ? `<button class="btn" onclick="unassignHandler('${r.citizenId}')">ยกเลิกที่พัก</button>` : `<button class="btn ok" data-citizen-id="${r.citizenId}" data-citizen-name="${r.name}" onclick="showAssignModal(this.dataset.citizenId, this.dataset.citizenName)">เข้าที่พัก</button>`}
            <button class="btn danger" onclick="deleteCitizenHandler('${r.citizenId}')">ลบ</button>
          </td>
        </tr>
        `;
      }).join("");
    }

    document.getElementById("btnAdd").addEventListener("click", () => {
      const payload = {
        citizenId: document.getElementById("citizenId").value,
        name: document.getElementById("name").value,
        age: document.getElementById("age").value,
        healthStatus: document.getElementById("healthStatus").value,
        registerDate: document.getElementById("registerDate").value,
        citizenType: document.getElementById("citizenType").value
      };
      const res = EVAC.Controller.addCitizen(payload);
      if (!res.ok) return EVAC.toast(res.msg, "danger");

      EVAC.toast("เพิ่มประชาชนสำเร็จ", "ok");
      document.getElementById("citizenId").value = "";
      document.getElementById("name").value = "";
      document.getElementById("age").value = "";
      render();
    });

    document.getElementById("btnExport").addEventListener("click", () => {
      EVAC.downloadText("citizens.csv", EVAC.Controller.exportCSV("citizens"));
    });

    document.getElementById("q").addEventListener("input", render);
    document.getElementById("filterType").addEventListener("change", render);

    // Delete citizen handler
    window.deleteCitizenHandler = function(citizenId){
      if (!confirm(`ยืนยันตั้งใจว่าต้องการลบ ${citizenId} หรือไม่?`)) return;
      
      const res = EVAC.Controller.deleteCitizen(citizenId);
      if (!res.ok) return EVAC.toast(res.msg, "danger");
      
      EVAC.toast("ลบประชาชนสำเร็จ", "ok");
      render();
    };

    // Assign modal dialog
    window.showAssignModal = function(citizenId, citizenName){
      const shelters = EVAC.DB.shelters.map(s => {
        const occ = EVAC.getShelterOccupancy(s.shelterId);
        const cap = Number(s.capacity || 0);
        const avail = cap - occ;
        return { ...s, occupancy: occ, available: avail };
      });
      
      let html = `<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999" id="assignModal">`;
      html += `<div style="background:#1a1f3a;padding:20px;border-radius:8px;max-width:400px;width:90%">`;
      html += `<h3 style="color:#fff;margin-top:0">${citizenName} - เลือกที่พัก</h3>`;
      html += `<div style="max-height:300px;overflow-y:auto;margin-bottom:15px">`;
      
      shelters.forEach(s => {
        const badge = s.available > 3 ? 'style="background:#31d0aa"' : s.available > 0 ? 'style="background:#f5a623"' : 'style="background:#d32f2f;opacity:0.5"';
        const disabled = s.available === 0 ? 'disabled style="opacity:0.5;cursor:not-allowed"' : '';
        html += `<div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">`;
        html += `<span style="color:#fff">${s.shelterId} - ${s.name} <span ${badge} style="padding:2px 6px;border-radius:4px;color:#000;font-size:12px;font-weight:bold">${s.available} ว่าง</span></span>`;
        html += `<button class="btn ok" onclick="assignToShelter('${citizenId}', '${s.shelterId}')" ${disabled}>เลือก</button>`;
        html += `</div>`;
      });
      
      html += `</div>`;
      html += `<button class="btn" onclick="document.getElementById('assignModal').remove()">ยกเลิก</button>`;
      html += `</div></div>`;
      
      document.body.insertAdjacentHTML('beforeend', html);
    };

    // Assign citizen to shelter
    window.assignToShelter = function(citizenId, shelterId){
      const res = EVAC.Controller.assignCitizen({ citizenId, shelterId });
      if (!res.ok) return EVAC.toast(res.msg, "danger");
      
      EVAC.toast(`${citizenId} เข้าที่พักสำเร็จ`, "ok");
      document.getElementById("assignModal").remove();
      render();
    };

    window.unassignHandler = function(citizenId){
      if (!confirm(`ยืนยันต้องการยกเลิกที่พักสำหรับ ${citizenId} หรือไม่?`)) return;
      
      EVAC.Controller.unassignCitizen(citizenId);
      EVAC.toast("ยกเลิกที่พักสำเร็จ", "ok");
      render();
    };

    render();
  </script>
</body>
</html>
